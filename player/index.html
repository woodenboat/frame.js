<!DOCTYPE html>
<html lang="en">
<head>
	<title>frame.js / player</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
	body {
		width: 100%;
		height: 100%;
		background-color: #000;
		color: #fff;
		margin: 0px;
		padding: 0;
		overflow: hidden;
	}

	/* Position the button on the bottom of the page. */
	#ui {
		position: absolute;
		bottom: 10px;
		left: 50%;
		transform: translate(-50%, -50%);
		text-align: center;
		font-family: 'Karla', sans-serif;
		z-index: 1;
	}

	a#magic-window {
		display: block;
		color: white;
		margin-top: 1em;
	}
	</style>
</head>

<body>
	<div id="ui">
		<div id="vr-button"></div>
		<a id="magic-window" href="#">Try it without a headset</a>
	</div>
</body>

<script src="js/libs/three.min.js"></script>
<script src="../src/Frame.js"></script>
<script src="js/libs/WebVR.js"></script>
<script src="js/libs/ModifiedVREffect.js"></script>
<script src="js/libs/VRControls.js"></script>
<script src="js/libs/webvr-ui.min.js"></script>
<script src="js/libs/webvr-polyfill.min.js"></script>
<script src="js/libs/es6-promise.min.js"></script>


<script>

FRAME.setDOM( document.getElementById( 'ui' ) );

var timeline = new FRAME.Timeline();
var player = new FRAME.Player();

var query = window.location.search;
// Currently active VRDisplay - default to window
var vrDisplay = window;
// EnterVRButton for rendering enter/exit UI.
var vrButton;

if ( query.substr( 1, 5 ) === 'file=' ) {

	timeline.load( query.substr( 6 ), function () {

		timeline.compile( player );
		// Setup WebVR support
		var renderer = FRAME.getResource( 'renderer' );
		// Append the canvas element created by the renderer to document body element.
		document.body.appendChild(renderer.domElement);
		// Create a three.js camera.
		var aspect = window.innerWidth / window.innerHeight;
		camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 10000);

		controls = new THREE.VRControls(camera);
		controls.standing = true;
		camera.position.y = controls.userHeight;

		// Apply VR stereo rendering to renderer.
		effect = new THREE.VREffect(renderer);
		effect.setSize(window.innerWidth, window.innerHeight);
		window.addEventListener('resize', onResize, true);
		window.addEventListener('vrdisplaypresentchange', onResize, true);

		// Initialize the WebVR UI.
		var uiOptions = {
			color: 'black',
			background: 'white',
			corners: 'square'
		};
		vrButton = new webvrui.EnterVRButton(renderer.domElement, uiOptions);
		vrButton.on('exit', function() {
			camera.quaternion.set(0, 0, 0, 1);
			camera.position.set(0, controls.userHeight, 0);
		});
		vrButton.on('hide', function() {
			document.getElementById('ui').style.display = 'none';
		});
		vrButton.on('show', function() {
			document.getElementById('ui').style.display = 'inherit';
		});
		document.getElementById('vr-button').appendChild(vrButton.domElement);
		document.getElementById('magic-window').addEventListener('click', function() {
			vrButton.requestEnterFullscreen();
		});
		setupStage();


		vrDisplay.requestAnimationFrame(animate);
		// window.requestAnimationFrame( animate );

	} );

}

//

var prevTime = 0;

function animate( time ) {

	player.tick( time - prevTime );
	timeline.update( player.currentTime );

	prevTime = time;

	// Only update controls if we're presenting.
	if (vrButton.isPresenting()) {
		controls.update();
	}
	// Render the scene.
	//effect.render(scene, camera);

	vrDisplay.requestAnimationFrame(animate);
	//window.requestAnimationFrame( animate );

}

function onResize(e) {
	effect.setSize(window.innerWidth, window.innerHeight);
	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	if (!player.isPlaying) {
		player.play();
	}
}

// Get the HMD, and if we're dealing with something that specifies
// stageParameters, rearrange the scene.
function setupStage() {
	navigator.getVRDisplays().then(function(displays) {
		if (displays.length > 0) {
			vrDisplay = displays[0];
			vrDisplay.requestAnimationFrame(animate);
		}
	});
}

</script>
</html>
